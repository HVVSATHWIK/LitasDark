(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();function m(o){o.classList.remove("hidden"),o.classList.add("visible")}function f(o){o.classList.remove("visible"),o.classList.add("hidden")}function l(o){g(o,"error")}function g(o,e="info"){const t=document.createElement("div");t.className=`message ${e}`,t.textContent=o,document.body.appendChild(t),setTimeout(()=>{t.classList.add("fade-out"),setTimeout(()=>{document.body.removeChild(t)},1e3)},3e3)}class w{constructor(){this.currentDocument=null,this.loadingCallbacks=new Set}async loadFromFile(e){if(!e||e.type!=="application/pdf")throw new Error("Invalid file type. Please select a PDF file.");if(e.size>50*1024*1024)throw new Error("File too large. Please select a file smaller than 50MB.");try{const t=await e.arrayBuffer();return this.currentDocument=await PDFLib.PDFDocument.load(t),this.notifyLoadingComplete(),this.currentDocument}catch(t){throw this.handleLoadError(t),t}}getCurrentDocument(){return this.currentDocument}isDocumentLoaded(){return this.currentDocument!==null}onLoadingComplete(e){this.loadingCallbacks.add(e)}offLoadingComplete(e){this.loadingCallbacks.delete(e)}notifyLoadingComplete(){this.loadingCallbacks.forEach(e=>{try{e(this.currentDocument)}catch(t){console.error("Error in loading callback:",t)}})}handleLoadError(e){throw e.message.includes("Invalid PDF structure")||e.name==="InvalidPDFException"?new Error("The file appears to be corrupted or not a valid PDF. Please try a different file."):new Error("Failed to load PDF. Please ensure the file is valid.")}}class y{constructor(){this.renderCache=new Map,this.maxCacheSize=10}async renderPage(e,t,r={}){const n=this.getCacheKey(e,t,r);if(this.renderCache.has(n))return this.renderCache.get(n);try{const a=await e.save(),d=await(await pdfjsLib.getDocument({data:a}).promise).getPage(t),h=r.scale||2,i=d.getViewport({scale:h}),c=document.createElement("canvas"),p=c.getContext("2d");return c.width=i.width,c.height=i.height,await d.render({canvasContext:p,viewport:i}).promise,this.applyThemeFilters(p,c.width,c.height,r),this.cacheCanvas(n,c),c}catch(a){throw new Error(`Failed to render page ${t}: ${a.message}`)}}async generateThumbnails(e){const t=e.getPageCount(),r=[],n=3;for(let a=0;a<t;a+=n){const s=[],d=Math.min(a+n,t);for(let i=a;i<d;i++)s.push(this.renderPage(e,i+1,{scale:.5}));(await Promise.allSettled(s)).forEach((i,c)=>{i.status==="fulfilled"?r[a+c]=i.value:(console.error(`Failed to generate thumbnail for page ${a+c+1}:`,i.reason),r[a+c]=this.createErrorThumbnail())})}return r}applyThemeFilters(e,t,r,n){const{theme:a="dark",brightness:s=100,contrast:d=100}=n;e.globalCompositeOperation="difference",e.fillStyle=this.getThemeFillColor(a),e.fillRect(0,0,t,r),e.globalCompositeOperation="source-over",e.filter=`brightness(${s}%) contrast(${d}%)`}getThemeFillColor(e){return{dark:"white",darker:"#ccc",darkest:"#999"}[e]||"white"}getCacheKey(e,t,r){return`${e.getTitle()||"untitled"}_${t}_${JSON.stringify(r)}`}cacheCanvas(e,t){if(this.renderCache.size>=this.maxCacheSize){const r=this.renderCache.keys().next().value;this.renderCache.delete(r)}this.renderCache.set(e,t)}createErrorThumbnail(){const e=document.createElement("canvas");e.width=150,e.height=200;const t=e.getContext("2d");return t.fillStyle="#333",t.fillRect(0,0,e.width,e.height),t.fillStyle="#fff",t.font="14px Arial",t.textAlign="center",t.fillText("Error",e.width/2,e.height/2),e}}class v{constructor(e){this.renderer=e,this.progressCallbacks=new Set}async convertToDarkMode(e,t={}){const r=e.getPageCount(),n=await PDFLib.PDFDocument.create();this.notifyProgress(0,r,"Starting conversion...");try{for(let s=1;s<=r;s++){this.notifyProgress(s-1,r,`Processing page ${s}...`);const d=await this.renderer.renderPage(e,s,t),h=d.toDataURL("image/png"),i=await n.embedPng(h),c=n.addPage([d.width,d.height]);c.drawImage(i,{x:0,y:0,width:c.getWidth(),height:c.getHeight()})}this.notifyProgress(r,r,"Finalizing PDF...");const a=await n.save({useObjectStreams:!0,compress:!0,optimizeForSize:!0});return this.notifyProgress(r,r,"Conversion complete!"),a}catch(a){throw new Error(`Conversion failed: ${a.message}`)}}onProgress(e){this.progressCallbacks.add(e)}offProgress(e){this.progressCallbacks.delete(e)}notifyProgress(e,t,r){this.progressCallbacks.forEach(n=>{try{n(e,t,r)}catch(a){console.error("Error in progress callback:",a)}})}}class P{static handlePDFError(e,t=""){console.error(`PDF Error in ${t}:`,e);const r={"Invalid PDF structure":"The PDF file appears to be corrupted. Please try a different file.",InvalidPDFException:"Invalid PDF format. Please ensure the file is a valid PDF.",getPage:"Failed to access PDF page. The file may be corrupted.",render:"Failed to render PDF page. Please try again.",embedPng:"Failed to process images. The PDF may contain unsupported content.",save:"Failed to save the converted PDF. Please try again."};for(const[n,a]of Object.entries(r))if(e.message.includes(n)||e.name===n)return new Error(a);return new Error(`An unexpected error occurred${t?` in ${t}`:""}. Please try again.`)}static async withErrorHandling(e,t=""){try{return await e()}catch(r){throw this.handlePDFError(r,t)}}}class u{static validateFile(e){if(!e)throw new Error("No file selected");if(e.type!=="application/pdf")throw new Error("Invalid file type. Please select a PDF file.");const t=50*1024*1024;if(e.size>t)throw new Error("File too large. Please select a file smaller than 50MB.");return!0}static validatePageRange(e,t,r){const n=parseInt(e,10),a=parseInt(t,10);if(isNaN(n)||isNaN(a))throw new Error("Page numbers must be valid integers");if(n<1||a<1)throw new Error("Page numbers must be greater than 0");if(n>r||a>r)throw new Error(`Page numbers cannot exceed ${r}`);if(n>a)throw new Error("Start page cannot be greater than end page");return{start:n,end:a}}static validateRotationAngle(e){const t=[0,90,180,270],r=parseInt(e,10);if(!t.includes(r))throw new Error("Rotation angle must be 0, 90, 180, or 270 degrees");return r}static validateThemeSettings(e){const{theme:t,brightness:r,contrast:n}=e;if(t&&!["dark","darker","darkest"].includes(t))throw new Error("Invalid theme selection");if(r!==void 0){const s=parseInt(r,10);if(isNaN(s)||s<50||s>150)throw new Error("Brightness must be between 50 and 150")}if(n!==void 0){const s=parseInt(n,10);if(isNaN(s)||s<50||s>150)throw new Error("Contrast must be between 50 and 150")}return!0}}class D{constructor(){this.pdfLoader=new w,this.pdfRenderer=new y,this.pdfConverter=new v(this.pdfRenderer),this.initializeEventListeners(),this.setupProgressHandling()}initializeEventListeners(){document.getElementById("pdfUpload").addEventListener("change",e=>{this.handleFileUpload(e.target.files[0])}),document.getElementById("generatePreviewButton").addEventListener("click",()=>{this.generatePreview()}),document.getElementById("convertButton").addEventListener("click",()=>{this.convertToDarkMode()}),["themeSelect","brightness","contrast"].forEach(e=>{document.getElementById(e).addEventListener("change",()=>{this.updatePreview()})}),document.getElementById("splitButton").addEventListener("click",()=>{this.splitPDF()}),document.getElementById("mergeButton").addEventListener("click",()=>{this.mergePDFs()}),document.getElementById("rotateButton").addEventListener("click",()=>{this.rotatePage()}),document.getElementById("backToTop").addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})}setupProgressHandling(){this.pdfConverter.onProgress((e,t,r)=>{this.updateProgressBar(e,t,r)})}async handleFileUpload(e){if(!e)return;const t=document.getElementById("loading");try{u.validateFile(e),m(t),await this.pdfLoader.loadFromFile(e),await this.generateThumbnails(),g("PDF loaded successfully! Generate a preview to see the dark mode effect.")}catch(r){l(r.message)}finally{f(t)}}async generateThumbnails(){const e=this.pdfLoader.getCurrentDocument();if(e)try{const t=await this.pdfRenderer.generateThumbnails(e),r=document.getElementById("thumbnails");r.innerHTML="",t.forEach((n,a)=>{if(n){const s=document.createElement("div");s.classList.add("thumbnail"),s.appendChild(n),s.setAttribute("role","button"),s.setAttribute("aria-label",`Page ${a+1} preview`),s.tabIndex=0,s.addEventListener("click",()=>{this.renderPage(a+1)}),r.appendChild(s)}})}catch(t){console.error("Error generating thumbnails:",t)}}async renderPage(e){const t=this.pdfLoader.getCurrentDocument();if(t)try{const r=this.getThemeSettings(),n=await this.pdfRenderer.renderPage(t,e,r);this.displayPreview(n)}catch{l(`Failed to render page ${e}`)}}async generatePreview(){if(!this.pdfLoader.isDocumentLoaded()){l("Please upload a PDF file first.");return}const e=document.getElementById("loading");try{m(e);const t=this.getThemeSettings(),r=this.pdfLoader.getCurrentDocument(),n=await this.pdfRenderer.renderPage(r,1,t);this.displayPreview(n),document.getElementById("preview").style.display="block"}catch(t){const r=P.handlePDFError(t,"preview generation");l(r.message)}finally{f(e)}}async updatePreview(){this.pdfLoader.isDocumentLoaded()&&await this.generatePreview()}async convertToDarkMode(){if(!this.pdfLoader.isDocumentLoaded()){l("Please upload a PDF file first.");return}const e=document.getElementById("loading");try{m(e);const t=this.getThemeSettings(),r=this.pdfLoader.getCurrentDocument(),n=await this.pdfConverter.convertToDarkMode(r,t);this.downloadPDF(n,"dark-mode.pdf"),g("PDF converted successfully!")}catch(t){const r=P.handlePDFError(t,"conversion");l(r.message)}finally{f(e)}}async splitPDF(){if(!this.pdfLoader.isDocumentLoaded()){l("Please upload a PDF file first.");return}try{const e=document.getElementById("startPage").value,t=document.getElementById("endPage").value,r=this.pdfLoader.getCurrentDocument(),{start:n,end:a}=u.validatePageRange(e,t,r.getPageCount()),s=await PDFLib.PDFDocument.create();(await s.copyPages(r,[...Array(a-n+1).keys()].map(i=>i+n-1))).forEach(i=>{s.addPage(i)});const h=await s.save();this.downloadPDF(h,"split_pdf.pdf","splitDownloadLink"),g("PDF split successfully!")}catch(e){l(e.message)}}async mergePDFs(){const e=document.getElementById("pdfFiles").files;if(e.length===0){l("Please select PDF files to merge.");return}try{const t=await PDFLib.PDFDocument.create(),r=[];for(const a of e){u.validateFile(a);const s=await a.arrayBuffer(),d=await PDFLib.PDFDocument.load(s);(await t.copyPages(d,d.getPageIndices())).forEach(i=>{t.addPage(i)}),r.push(a.name.replace(".pdf",""))}const n=await t.save();this.downloadPDF(n,`${r.join("_")}_merged.pdf`,"mergeDownloadLink"),g("PDFs merged successfully!")}catch(t){l(`Failed to merge PDFs: ${t.message}`)}}async rotatePage(){if(!this.pdfLoader.isDocumentLoaded()){l("Please upload a PDF file first.");return}try{const e=document.getElementById("rotatePageNumber").value,t=document.getElementById("rotateAngle").value,r=this.pdfLoader.getCurrentDocument(),n=parseInt(e,10),a=u.validateRotationAngle(t);if(n<1||n>r.getPageCount())throw new Error(`Page number must be between 1 and ${r.getPageCount()}`);r.getPage(n-1).setRotation(PDFLib.degrees(a));const d=await r.save();this.downloadPDF(d,"rotated_pdf.pdf","rotateDownloadLink"),g("Page rotated successfully!")}catch(e){l(e.message)}}getThemeSettings(){const e={theme:document.getElementById("themeSelect").value,brightness:parseInt(document.getElementById("brightness").value,10),contrast:parseInt(document.getElementById("contrast").value,10),scale:1.5};try{u.validateThemeSettings(e)}catch(t){return l(t.message),{theme:"dark",brightness:100,contrast:100,scale:1.5}}return e}displayPreview(e){const t=document.getElementById("previewCanvas"),r=t.getContext("2d");t.width=e.width,t.height=e.height,r.drawImage(e,0,0)}downloadPDF(e,t,r="downloadLink"){const n=new Blob([e],{type:"application/pdf"}),a=URL.createObjectURL(n),s=document.getElementById(r);s.href=a,s.download=t,s.style.display="block",setTimeout(()=>URL.revokeObjectURL(a),1e3)}updateProgressBar(e,t,r){const n=document.getElementById("progressBar");if(n){const a=e/t*100;n.style.width=`${a}%`,n.setAttribute("aria-valuenow",a),n.setAttribute("aria-valuetext",r)}}}document.addEventListener("DOMContentLoaded",()=>{new D});window.addEventListener("error",o=>{console.error("Global error:",o.error)});window.addEventListener("unhandledrejection",o=>{console.error("Unhandled promise rejection:",o.reason),o.preventDefault()});
